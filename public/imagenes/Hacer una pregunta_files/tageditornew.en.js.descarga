"use strict";StackExchange.tagEditor=function(e,t){function n(){t.initialFocus=!0}function r(){if("undefined"==typeof kt){for(var e=StackExchange.tagEditor.requiredTags,t=[],n=0;n<e.length;n++)t.push(d(e[n]).replace(/[.+]/g,"\\$&"));kt=new RegExp("^(?:"+t.join("|")+")$")}return kt}function i(){if(!t.ignoreRequired){var e=StackExchange.tagEditor.requiredTags;if(e&&/^ ?$/.test(gt.val())){var n=r();0===ht.add(mt).children().filter(function(){return n.test($(this).text())}).length&&P(e)}}}function o(){return t.showAllWhenEmptyAndFocused&&u()}function a(e,n){var r=Y(e);if(t.tagMenus&&r.data("tag-menu-tagname",e),!n){if(r.hasClass("s-tag")){var i="<svg class='svg-icon iconClearSm pe-none' width='14' height='14' viewBox='0 0 14 14'><path d='M12 3.41L10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7z'></path></svg>",o=$("<a>",{"class":"js-delete-tag s-tag--dismiss","title":t.tooltipDeleteTag||"Remove tag"});o.append($(i)),r.append(o)}else r.append($("<span>",{"class":"js-delete-tag delete-tag","title":t.tooltipDeleteTag||"Remove tag"}));nt.trigger("tagSpanCreated",[r])}return t.tagSpanCreated&&t.tagSpanCreated(r),r}function s(e){var t=$([]),n=$([]);switch(e){case jt.all:t=ht.find(".rendered-element"),n=mt.find(".rendered-element");break;case jt.left:t=ht.find(".rendered-element:last");break;case jt.right:n=mt.find(".rendered-element:first");break;case jt.all_left:t=ht.find(".rendered-element");break;case jt.all_right:n=mt.find(".rendered-element")}return{"pre":t,"post":n}}function c(e){e=e||jt.all;var t=s(e),n=t.pre.map(function(e,t){return $(t).text()}).get(),r=n.join(" ");r.length&&(r+=" ");var i=t.post.map(function(e,t){return $(t).text()}).get(),o=i.join(" ");o.length&&gt.val().length&&(o=" "+o);var a=gt.val();return n=n.concat(i),{"text":r+gt.val()+o,"lengthBeforeInput":r.length,"val":a,"tags":n}}function l(t){t=t||c(),setTimeout(function(){e.trigger("tageditor:renderedchange",[t.tags,t.val])}),k(),v()}function u(){var e=gt.val();return(""===e||" "===e)&&0===ht.add(mt).children().filter(function(){return!/^\s*$/.test($(this).text())}).length}function d(e){return t.getTagNameFromData?t.getTagNameFromData(e):e.Name}function f(e){e=e||jt.all;var t=gt.caret(),n=gt[0].selectionDirection,r=s(e);if(r.pre.add(r.post).length){var i=c(e);gt.val(i.text),r.pre.remove(),r.post.remove(),gt.caret(t.start+i.lengthBeforeInput,t.end+i.lengthBeforeInput),ut&&(gt[0].selectionDirection=n),N(),l()}}function p(e){if(t.operators&&t.operators.test(e))return $("<span class='rendered-element'/>").text(e);var n=a(e).addClass("rendered-element");return h(e)||n.addClass("invalid-tag temp-tag__danger").attr("title",t.tooltipInvalidTag||"invalid tag"),n}function h(e){return t.invalid&&t.invalid[e]?!1:t.isTagValid&&!t.isTagValid(e)?!1:!0}function g(n){if(!xt){var r;if(r=n?{"start":gt.val().length,"end":gt.val().length}:gt.caret(),-1==r.start&&(r.start=r.end=0),!ut&&r.start!==r.end)return f(),k(),void 0;var o=gt.val(),a=o.substr(0,r.start),s=o.substr(r.end),d=gt[0].selectionDirection,h=t.allowSpaces?/[,;]+/:/[,;\s]+/,g="function"==typeof t.customCleanUpSplit?t.customCleanUpSplit:function(e){return e.split(h)},m=g(a+"!"),m=(a+"!").split(h);m[m.length-1]="!"===m[m.length-1]?"":m[m.length-1].slice(0,-1);var v=g(s),b=m.pop(),y=b.length;b+=o.substring(r.start,r.end),b+=v.shift(),m=Z(m.join(" ")),v=Z(v.join(" "));var w,x=!!m.length||!!v.length;for(w=0;w<m.length;w++)p(m[w]).appendTo(ht);for(w=0;w<v.length;w++)p(v[w]).appendTo(mt);b!==gt.val()&&gt.val(b);var S=nt.find(".rendered-element"),C=Q(S.map(function(e,t){return $(t).text()}).get(),ht.find(".rendered-element").length);w=0,S.filter(function(){return!C[w++]}).remove();var _=c(),E=$.trim(_.text),T=e.val();E!=T&&(e.val(E).trigger("change"),StackExchange.MarkdownEditor&&!t.ignoreStyleCode&&styleCode.updateLangdivDelayed.trigger(E.split(/ /g))),x&&l(_),V&&(gt.caret(y,y+r.end-r.start),ut&&(gt[0].selectionDirection=d),j(),i()),k(),u()?gt.attr("placeholder")!==K&&gt.attr("placeholder",K):""!==gt.attr("placeholder")&&gt.attr("placeholder","")}}function m(e,t){if(!Array.isArray(e)||!Array.isArray(t)||e.length!==t.length)return!1;const n=e.concat().sort(),r=t.concat().sort();for(var i=0;i<n.length;i++)if(n[i]!==r[i])return!1;return!0}function v(){if(It)return It=!1,void 0;var e=nt.find(".rendered-element"),t=e.toArray().map(function(e){return $(e).text()});0!==Ot.length&&(t&&t.length>0?Dt.trigger(t,b):b())}function b(e){if(!e||!e.subCommunities||0===e.subCommunities.length)return Pt=[],Ot.empty(),void 0;var t=e.subCommunities.map(function(e){return e.slug});m(Pt,t)||(Pt=t,Ot.html(e.fullHtml))}function y(e,t,n,r){var i,o;if("string"==typeof e)o=e;else{if(!e.length)return;i=e,o=i.text()}for(var a=Z(gt.val()),s=0;s<a.length;s++)p(a[s]).appendTo(ht);if(gt.val(o),i){var c=$($.unique(i.prevAll(".rendered-element").get()));i.nextAll(".rendered-element").prependTo(mt),c.appendTo(ht),i.remove()}else mt.find(".rendered-element").appendTo(ht);(V||!n)&&gt.focus(),t&&gt.caret(0,0),r||l()}function w(e){var t=e.val(),n="c_"+t;if(n in Lt)return Lt[n];var r=$("<span />").css({"font-family":e.css("font-family"),"font-size":e.css("font-size"),"display":"inline-block"});r.text(e.val()),r.insertAfter(e);var i=r.innerWidth();return r.remove(),Lt[n]=i,i}function k(){lt&&(tt=nt.innerWidth());{var e=w(gt)+19;ht.outerWidth()}gt.css("width",e);var t=gt.position().top,n=t;return n>0&&pt>n+ft?void 0:t+nt.scrollTop()+ft<pt?(nt.scrollTop(0),void 0):(nt.scrollTop(t-(pt-ft)/2+nt.scrollTop()),void 0)}function x(e,t){var n;n=e>0?mt.find("> *"):ht.find("> *");for(var r,i,o=gt.position(),a=gt.val().length,s=a>0?gt.caret().start/a:.5,c=o.left+gt.width()*s,l=0;l<n.length;l++){var u=n.eq(e>0?l:n.length-l-1),d=u.position();if("undefined"!=typeof i){if(d.top!==i)break}else{var p=Math.abs(d.top-o.top);if(!(p>ft/2))continue;i=d.top}var h=d.left+u.width()/2;if(0>e&&c>h||e>0&&h>c){r=r||u;break}r=u}if(r){if(t){for(;r.parent().length;)f(e>0?jt.right:jt.left);gt.caret(0,gt.val().length)}else y(r);return!0}return!1}function S(){Et=!0,setTimeout(function(){Et=!1},0)}function C(){var e=Z(gt.val())[0];if(e){var t=$("<span data-tag-name='"+e+"'/>");L(t)}}function _(e){if(!ut&&e.shiftKey&&Rt[e.which]||e.ctrlKey&&65===e.which)return f(),!0;var n,r,i=gt.caret(),o=gt[0].selectionDirection,a="forward"===o?i.end:i.start,s=a===gt.val().length,c=0===a;switch(e.which){case 37:return c?(n=ht.find(".rendered-element:last"),n.length?(e.shiftKey?f(jt.left):y(n),e.shiftKey):!0):!0;case 39:return s?(r=mt.find(".rendered-element:first"),r.length?(e.shiftKey?f(jt.right):y(r,!0),e.shiftKey):!0):!0;case 8:return c?(n=ht.find(".rendered-element:last"),n.length?(gt.val(n.text()+gt.val()),gt.caret(n.text().length,n.text().length),n.remove(),l(),!1):!0):!0;case 46:return s?(r=mt.find(".rendered-element:first"),r.length?(gt.val(gt.val()+r.text()),gt.caret(a,a),r.remove(),l(),!1):!0):!0;case 38:if(x(-1,e.shiftKey))return!1;case 36:return n=ht.find(".rendered-element:first"),n.length?(e.shiftKey?f(jt.all_left):y(n,!0),e.shiftKey):!0;case 40:var u=et.children("div:first");if(u.length)return S(),u.focus(),!1;if(x(1,e.shiftKey))return!1;case 35:return r=mt.find(".rendered-element:last"),r.length?(e.shiftKey?f(jt.all_right):y(r),e.shiftKey):!0;case 9:S(),t.renderErrorTagIfNoResults&&!T()&&C();break;case 13:if(T())return!1;break;case 32:if(t.allowSpaces)return!0;if(t.spaceSelectsTopSuggestion===!1)return!1;if(t.spaceSelectsTopSuggestion&&T())return L(et.children("div:first")),!1}return!0}function E(e){return 27===e.which&&et.length>0?(N(),e.preventDefault(!0),e.stopPropagation(),!1):!0}function T(){return!!et.length&&!et.hasClass("no-results")}function j(e){var n=X(gt.val())||"";return t.allowUpperCaseTagNames&&(n=n.toLocaleLowerCase()),$t!==n||e?($t=n,n.length||o()?(A(n,function(e){n===$t&&V&&P(e,n)}),void 0):(N(),void 0)):void 0}function A(e,t){var n=I(e);Nt[n]?t(Nt[n]):Ft.trigger(e,t)}function O(){return t.tagApiUrl||"/filter/tags"}function I(e){return O()+"|"+e}function P(e,n){et.remove(),xt=!1;for(var r=nt.height(),i=J(nt.find(".rendered-element").map(function(e,t){return $(t).text()}).get(),ht.find(".rendered-element").length),o=e.length-1;o>=0;o--)-1!==i.indexOf(d(e[o]))&&e.splice(o,1);var a=e.length;if(0===a)return et=$("<div class='tag-suggestions no-results box-border fs-cation fc-light c-default'>No results found</div>").css({"position":"absolute","left":nt.position().left,"top":nt.position().top+r+1+t.suggestionsTopMargin,"width":it}).insertAfter(nt),t.noResultsCallback&&t.noResultsCallback(et,n),void 0;et=$("<div class='tag-suggestions js-tag-suggestions box-border' />").css({"position":"absolute","left":nt.position().left,"top":nt.position().top+r+1+t.suggestionsTopMargin,"width":it}).insertAfter(nt),t.onCreatingTagSuggestions&&t.onCreatingTagSuggestions(i||[]);for(var s=t.suggestionTagBoxRenderer||M,o=0;o<e.length;o++){var c=s(e[o],n).attr("tabindex",vt||0).addClass("js-tag-suggestion").appendTo(et);D(c),o%z!==0||at||c.css("clear","both")}et.on({"keydown":U,"keyup":B,"click":function(e){F(e)||(L($(this)),e.stopPropagation())},"focus":function(){Et&&1===a?L($(this)):xt=!0},"blur":function(){xt=!1}},".js-tag-suggestion")}function M(e,n){var r=d(e),i=$("<div class='f:bs-ring outline-none' />").css("width",at?"auto":ot).data("tag-name",(e.Negated?"not ":"")+(e.SynonymOf||r)),o=$("<div class='d-flex ai-center' />"),s=$("<div class='flex--item mr6' />");i.append(o),o.append(s),n&&(n=n.replace(/-/g,"").replace(/\*+/g,"	").replace(/([^\t])(?=[^\t])/g,"$1-*").replace(/\+/g,"\\+").replace(/\./g,"\\.").replace(/\t/g,".*"));var c=t.operators&&t.operators.test(r),l=c?$('<span class="px4 fs-caption">').text(r):a(r,!0),u=l.html();if(n&&(u=u.replace(new RegExp("("+n+")"),"<span class='match'>$1</span>")),at&&l.addClass("m0"),e.Negated&&o.prepend($('<div class="flex--item mr6 fs-caption">').text("not")),s.append(l.html(u)),!e.Count||at||c||o.append($("<div class='flex--item fs-fine truncate mr6' />").html(e.Count)),W&&!at&&!c){var f="";if(e.Excerpt&&(f=e.Excerpt),f.length&&i.append($("<p class='mt6 mb0 v-truncate4 lh-md' />").text(f)),e.Synonyms&&e.Synonyms.length)for(var p=$("<p >also:</p>").appendTo(i),h=e.Synonyms.split(/\|/),g=0;g<h.length;g++)f=h[g],n&&(f=f.replace(new RegExp("("+n+")"),"<span class='match'>$1</span>")),g>0&&(f=", "+f),p.append("<span>"+f+"</span>")}if(G&&!at&&!c){var m=e.InfoUrl;m||(m=(e.IsDiverged?StackExchange.options.site.routePrefix:"")+"/tags/"+encodeURIComponent(e.SynonymOf||r)+"/info"),$('<a class="ml-auto flex--item s-btn s-btn__muted p2 js-tag-info-btn" target="_blank" />').attr("href",m).append(Svg.HelpSm).appendTo(o)}return i}function D(e){var t=e.find("p.more-info");"undefined"==typeof Tt&&(Tt=ot-5-t.outerWidth());var n=e.find(".rendered-element:first").outerWidth();n>Tt&&t.find("a").text("info")}function L(e){gt.val(e.data("tag-name")),N(),y(""),g()}function R(e){StackExchange.options.enableLogging&&(console.log("tag editor new: "+e),"string"!=typeof e&&console.log(e))}function N(){et.remove(),et=$(),xt=!1,Ft.cancel()}function F(e){return $(e.target).closest("a").length>0}function U(e){var n;switch(e.which){case 39:case 40:return $(this).next("div").focus(),!1;case 37:return $(this).prev("div").focus(),!1;case 38:return n=$(this).prev("div"),n.length?n.focus():gt.focus(),!1;case 13:if(F(e))break;return L($(this)),!1;case 32:return t.spaceSelectsTopSuggestion&&L($(this)),!1}}function B(e){return 27===e.which?(N(),gt.focus(),e.stopPropagation(),!1):!0}if(t||(t={}),"undefined"==typeof t.initialFocus&&(t.initialFocus=e.is(":focus")),!e.is(":visible")){var q=t.__tryNumber||0,H=$("body").is(":visible");return 3>q?(t.__tryNumber=q+(H?1:0),e.bind("focus",n),setTimeout(function(){e.unbind("focus",n),StackExchange.tagEditor(e,t)},300),void 0):($("body.review-task-page").length||StackExchange.debug.log("tag box is invisible, couldn't start tag editor"),void 0)}var V=!!t.initialFocus,z=t.columns||3,W="undefined"==typeof t.excerpts||t.excerpts,G="undefined"==typeof t.learnMore||t.learnMore,K=e.attr("placeholder")||"",Y=function(e){return window.tagRenderer(e,null,"span",t.useStacksClasses)},Q=t.customFilterTags||function(e){var n={};return e.map(function(e){return/^\s*$/.test(e)?!1:n[e]===!0?!1:(t.operators&&t.operators.test(e)||(n[e]=!0),!0)})},J=t.customExistingTags||function(e){return e},Z=t.customSafeTags||function(e){var n=StackExchange.helpers.sanitizeAndSplitTags(e,!1,!!t.operators,t.allowUpperCaseTagNames)||[];return e&&$.trim(e)&&R('safeTags("{0}") => {1}'.formatUnicorn(e,n.toString())),n},X=t.sanitizeSearchTerm||function(e){return Z(e)[0]},et=$(),tt=e.innerWidth(),nt=$("<div class='js-tag-editor tag-editor multi-line' />").insertAfter(e);nt.data("target-field",e.get(0)),t.extraTagEditorCssClass&&nt.addClass(t.extraTagEditorCssClass),["padding-right","padding-left","box-sizing","margin-top","margin-bottom"].forEach(function(t){nt.css(t,e.css(t))});var rt="border-box"===e.css("box-sizing");rt&&(tt+=parseInt(nt.css("border-right-width"),10)+parseInt(nt.css("border-left-width"),10));var it=t.suggestionsWidth||tt,ot=(it-12)/z|0,at=t.responsiveIsh&&150>ot;nt.css("width",tt);var st=e.css("display");e.hide();var ct=getComputedStyle(e[0]).width,lt=/%$/.test(ct);lt&&nt.css("width",ct),"inline"===st&&nt.css("display","inline-block");var ut="selectionDirection"in e[0],dt=Y("test").appendTo(nt),ft=rt?nt.outerHeight():nt.innerHeight(),pt=e.innerHeight();dt.remove(),rt&&(pt+=parseInt(nt.css("border-top-width"),10)+parseInt(nt.css("border-bottom-width"),10));var ht=$("<span />").appendTo(nt),gt=$("<input type='text' autocomplete='off' tabIndex='0'/>").appendTo(nt).val(e.val()+" ").attr("placeholder",K),mt=$("<span />").appendTo(nt),vt=e.attr("tabIndex"),bt=e.attr("id");if(bt){var yt=$("label[for='"+bt+"']");if(yt.length){var wt="tageditor-replacing-"+bt+"--input";gt.attr("id",wt),yt.attr("for",wt)}}vt&&gt.attr("tabIndex",vt),e.hasClass("s-input")&&(nt.addClass("s-input").css({"paddingTop":0,"paddingBottom":0}),gt.addClass("s-input")),gt.addClass("js-tageditor-replacing");var kt,xt=!1,St=V;gt.focus(function(t,n){V=!0,i(),St||(n||e.triggerHandler("focus",!0),St=!0),o()&&j(!0)});var Ct=!1;nt.mousedown(function(){Ct=!0,$(document).one("mouseup",function(){setTimeout(function(){V||(e.triggerHandler("blur"),St=!1),Ct=!1},0)})}),gt.blur(function(){V=!1,setTimeout(function(){xt||(N(),g(),Ct||(e.triggerHandler("blur"),St=!1)),Ct=!1},0)}),e.focus(function(e,t){t||gt.trigger("focus",!0)}),gt.on({"keydown":_,"keyup":E,"input":function(){setTimeout(g,0)}}),nt.delegate(".rendered-element","click",function(e){var t=$(this);$(e.target).hasClass("js-delete-tag")&&t.text(""),y(t),g()}),nt.click(function(e){e.target===this&&(y(""),g())}),nt.on("rerender",function(){f(),g(!0)});var _t,Et,$t,Tt,jt={"left":1,"right":2,"all_left":3,"all_right":4,"all":5},At="/collectives/shared/get-communities-by-tags",Ot=nt.closest(".js-tag-editor-container").find(".js-community-icons"),It=!Ot.is(":empty"),Pt=[],Mt=[],Dt=StackExchange.helpers.DelayedReaction(function(e,t){return m(Mt,e)?(t(_t),void 0):(Mt=e,StackExchange.helpers.addSpinner(nt,{"position":"absolute","right":10,"top":pt/2-2}),$.ajax({"url":At,"data":{"tags":e},"traditional":!0}).done(function(e){_t=e,StackExchange.helpers.removeSpinner(),t(e)}),void 0)},400,{"sliding":!0}),Lt={},Rt={"35":!0,"36":!0,"37":!0,"38":!0,"39":!0,"40":!0},Nt={},Ft=StackExchange.helpers.DelayedReaction(function(e,n){StackExchange.helpers.addSpinner(nt,{"position":"absolute","right":10,"top":pt/2-2});var r=null;if(t.getDataPromise)r=t.getDataPromise(e);else{var i=O(),o={"q":e,"newstyle":!0};r=$.get(i,o,"json")}r.done(function(t){Nt[I(e)]=t,StackExchange.helpers.removeSpinner(),n(t)})},400,{"sliding":!0});g(!0),StackExchange.tagEditor.ready.resolve(),e[0].func_clear=function(){e.val(""),gt.val("").blur(),nt.find(".rendered-element").remove()},e[0].func_add=function(e){var t=gt.val();gt.val(e),y(t,!1,!0),g()},e[0].func_finish=function(){y("")},e[0].func_redraw=function(t){var n=e.val();e.val(""),gt.val("").blur(),nt.find(".rendered-element").remove(),gt.val(n),y("",!1,!0,!t),g()}},StackExchange.tagEditor.ready=$.Deferred();